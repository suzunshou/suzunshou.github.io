<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 3.9.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0"><link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222"><meta name="google-site-verification" content="true"><meta name="msvalidate.01" content="809ED7241B89AE83EC3158A325D2AEA7"><meta name="baidu-site-verification" content="true"><link rel="stylesheet" href="/css/main.css?v=7.4.0"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"7.4.0",exturl:!1,sidebar:{position:"left",display:"hide",offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"flat"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!0},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},translation:{copy_button:"复制",copy_success:"复制成功",copy_failure:"复制失败"},sidebarPadding:40}</script><meta name="description" content="Kafka的网络通信模型是基于Java NIO的Reactor多线程模型实现的。从Kakfa的SocketServer.scala中可以看到一段关于Kafka网络模型的说明。 123456/** * An NIO socket server. The threading model is *   1 Acceptor thread that handles new connections *"><meta name="keywords" content="Kafka"><meta property="og:type" content="article"><meta property="og:title" content="Kafka - 网络通信模型"><meta property="og:url" content="https://bug-free.cn/2020/01/18/Kafka-网络通信模型/index.html"><meta property="og:site_name" content="Bug Free"><meta property="og:description" content="Kafka的网络通信模型是基于Java NIO的Reactor多线程模型实现的。从Kakfa的SocketServer.scala中可以看到一段关于Kafka网络模型的说明。 123456/** * An NIO socket server. The threading model is *   1 Acceptor thread that handles new connections *"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bug-free.cn/images/common-nio.png"><meta property="og:image" content="https://bug-free.cn/images/advance-nio.png"><meta property="og:image" content="https://bug-free.cn/images/kafka-nio.png"><meta property="og:updated_time" content="2021-06-13T08:42:53.951Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Kafka - 网络通信模型"><meta name="twitter:description" content="Kafka的网络通信模型是基于Java NIO的Reactor多线程模型实现的。从Kakfa的SocketServer.scala中可以看到一段关于Kafka网络模型的说明。 123456/** * An NIO socket server. The threading model is *   1 Acceptor thread that handles new connections *"><meta name="twitter:image" content="https://bug-free.cn/images/common-nio.png"><link rel="canonical" href="https://bug-free.cn/2020/01/18/Kafka-网络通信模型/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,isPage:!1,isArchive:!1}</script><title>Kafka - 网络通信模型 | Bug Free</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-147531716-1"></script><script>var host=window.location.hostname;if("localhost"!==host){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-147531716-1")}</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?f4fb0ae8dc548b7d25c4d35357cc6b32";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container use-motion"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Bug Free</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">疯狂，热情，追求。</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article itemscope itemtype="http://schema.org/Article"><div class="post-block post"><link itemprop="mainEntityOfPage" href="https://bug-free.cn/2020/01/18/Kafka-网络通信模型/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="生命就是个Bug."><meta itemprop="description" content="说出你的故事"><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Bug Free"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Kafka - 网络通信模型</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-01-18 15:05:00" itemprop="dateCreated datePublished" datetime="2020-01-18T15:05:00+08:00">2020-01-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-06-13 16:42:53" itemprop="dateModified" datetime="2021-06-13T16:42:53+08:00">2021-06-13</time></span></div></header><div class="post-body" itemprop="articleBody"><pre><code>Kafka的网络通信模型是基于Java NIO的Reactor多线程模型实现的。</code></pre><p>从Kakfa的<code>SocketServer.scala</code>中可以看到一段关于Kafka网络模型的说明。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An NIO socket server. The threading model is</span></span><br><span class="line"><span class="comment"> *   1 Acceptor thread that handles new connections</span></span><br><span class="line"><span class="comment"> *   Acceptor has N Processor threads that each have their own selector and read requests from sockets</span></span><br><span class="line"><span class="comment"> *   M Handler threads that handle requests and produce responses back to the processor threads for writing.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>Kafka包含了<code>1个Acceptor</code>线程用来接收新<code>连接</code>、<code>N个Processor</code>线程用来处理<code>Socket</code>请求、<code>M个Handler</code>线程用来处理<code>业务</code>逻辑。</p><p>首先，对比一下几种NIO模型。</p><ul><li><p>普通NIO<br><img src="/images/common-nio.png" alt="common-nio"></p></li><li><p>高并发NIO<br><img src="/images/advance-nio.png" alt="advance-nio"></p></li><li><p>Kafka NIO<br><img src="/images/kafka-nio.png" alt="kafka-nio"></p></li></ul><p>接着，从源码层面来分析。</p><p>Broker启动的时候，会创建<code>Acceptor</code>以及<code>Processor</code>，并初始化<code>KafkaApis</code>及<code>请求处理池</code>。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create and start the socket server acceptor threads so that the bound port is known.</span></span><br><span class="line"><span class="comment">// Delay starting processors until the end of the initialization sequence to ensure</span></span><br><span class="line"><span class="comment">// that credentials have been loaded before processing authentications.</span></span><br><span class="line"><span class="comment">//启动Acceptor，绑定端口</span></span><br><span class="line">socketServer = <span class="keyword">new</span> <span class="type">SocketServer</span>(config, metrics, time, credentialProvider)</span><br><span class="line">socketServer.startup(startupProcessors = <span class="literal">false</span>)</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* start processing requests */</span></span><br><span class="line">apis = <span class="keyword">new</span> <span class="type">KafkaApis</span>(socketServer.requestChannel, replicaManager, adminManager, groupCoordinator, transactionCoordinator,</span><br><span class="line">  kafkaController, zkClient, config.brokerId, config, metadataCache, metrics, authorizer, quotaManagers,</span><br><span class="line">  fetchManager, brokerTopicStats, clusterId, time, tokenManager)</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requestHandlerPool = <span class="keyword">new</span> <span class="type">KafkaRequestHandlerPool</span>(config.brokerId, socketServer.requestChannel, apis, time, config.numIoThreads)</span><br></pre></td></tr></table></figure><p>startup方法创建了连接数管理器、启动Acceptor线程及Processor线程。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">startup</span></span>(startupProcessors: <span class="type">Boolean</span> = <span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.synchronized &#123;</span><br><span class="line">    <span class="comment">//用于维护单IP下的连接数，防止资源过载</span></span><br><span class="line">    connectionQuotas = <span class="keyword">new</span> <span class="type">ConnectionQuotas</span>(maxConnectionsPerIp, maxConnectionsPerIpOverrides)</span><br><span class="line">    createAcceptorAndProcessors(config.numNetworkThreads, config.listeners)</span><br><span class="line">    <span class="keyword">if</span> (startupProcessors) &#123;</span><br><span class="line">      startProcessors()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">createAcceptorAndProcessors</span></span>(processorsPerListener: <span class="type">Int</span>,</span><br><span class="line">                                        endpoints: <span class="type">Seq</span>[<span class="type">EndPoint</span>]): <span class="type">Unit</span> = synchronized &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> sendBufferSize = config.socketSendBufferBytes</span><br><span class="line">  <span class="keyword">val</span> recvBufferSize = config.socketReceiveBufferBytes</span><br><span class="line">  <span class="keyword">val</span> brokerId = config.brokerId</span><br><span class="line">  <span class="comment">//遍历server.properties配置的listeners属性，Kafka单机支持多协议、多端口</span></span><br><span class="line">  endpoints.foreach &#123; endpoint =&gt;</span><br><span class="line">    <span class="keyword">val</span> listenerName = endpoint.listenerName</span><br><span class="line">    <span class="keyword">val</span> securityProtocol = endpoint.securityProtocol</span><br><span class="line">    <span class="comment">//创建Acceptor线程，配置socket buffer，并开启nioSelector，启动端口监听客户端</span></span><br><span class="line">    <span class="keyword">val</span> acceptor = <span class="keyword">new</span> <span class="type">Acceptor</span>(endpoint, sendBufferSize, recvBufferSize, brokerId, connectionQuotas)</span><br><span class="line">    <span class="comment">//添加连接处理器Processor</span></span><br><span class="line">    addProcessors(acceptor, endpoint, processorsPerListener)</span><br><span class="line">    <span class="type">KafkaThread</span>.nonDaemon(<span class="string">s"kafka-socket-acceptor-<span class="subst">$listenerName</span>-<span class="subst">$securityProtocol</span>-<span class="subst">$&#123;endpoint.port&#125;</span>"</span>, acceptor).start()</span><br><span class="line">    acceptor.awaitStartup()</span><br><span class="line">    acceptors.put(endpoint, acceptor)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Acceptor线程内部，不断循环，监听OP_ACCEPT事件，再将请求交给Processor去处理I/O。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Accept loop that checks for new connection attempts</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123;</span><br><span class="line">  serverChannel.register(nioSelector, <span class="type">SelectionKey</span>.<span class="type">OP_ACCEPT</span>)</span><br><span class="line">  startupComplete()</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> currentProcessor = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> ready = nioSelector.select(<span class="number">500</span>)</span><br><span class="line">        <span class="keyword">if</span> (ready &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">val</span> keys = nioSelector.selectedKeys()</span><br><span class="line">          <span class="keyword">val</span> iter = keys.iterator()</span><br><span class="line">          <span class="keyword">while</span> (iter.hasNext &amp;&amp; isRunning) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">val</span> key = iter.next</span><br><span class="line">              iter.remove()</span><br><span class="line">              <span class="keyword">if</span> (key.isAcceptable) &#123;</span><br><span class="line">                <span class="keyword">val</span> processor = synchronized &#123;</span><br><span class="line">                  currentProcessor = currentProcessor % processors.size</span><br><span class="line">                  processors(currentProcessor)</span><br><span class="line">                &#125;</span><br><span class="line">                  <span class="comment">//获取连接</span></span><br><span class="line">                  accept(key, processor)</span><br><span class="line">              &#125; <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"Unrecognized key state for acceptor thread."</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 轮询到下一个Processor</span></span><br><span class="line">                currentProcessor = currentProcessor + <span class="number">1</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">              <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt; error(<span class="string">"Error while accepting connection"</span>, e)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="comment">// We catch all the throwables to prevent the acceptor thread from exiting on exceptions due</span></span><br><span class="line">        <span class="comment">// to a select operation on a specific channel or a bad request. We don't want</span></span><br><span class="line">        <span class="comment">// the broker to stop responding to requests from other clients in these scenarios.</span></span><br><span class="line">        <span class="keyword">case</span> e: <span class="type">ControlThrowable</span> =&gt; <span class="keyword">throw</span> e</span><br><span class="line">        <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt; error(<span class="string">"Error occurred"</span>, e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    debug(<span class="string">"Closing server socket and selector."</span>)</span><br><span class="line">    <span class="type">CoreUtils</span>.swallow(serverChannel.close(), <span class="keyword">this</span>, <span class="type">Level</span>.<span class="type">ERROR</span>)</span><br><span class="line">    <span class="type">CoreUtils</span>.swallow(nioSelector.close(), <span class="keyword">this</span>, <span class="type">Level</span>.<span class="type">ERROR</span>)</span><br><span class="line">    shutdownComplete()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Accept a new connection</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">accept</span></span>(key: <span class="type">SelectionKey</span>, processor: <span class="type">Processor</span>) &#123;</span><br><span class="line">  <span class="keyword">val</span> serverSocketChannel = key.channel().asInstanceOf[<span class="type">ServerSocketChannel</span>]</span><br><span class="line">  <span class="comment">//监听新连接</span></span><br><span class="line">  <span class="keyword">val</span> socketChannel = serverSocketChannel.accept()</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//增加连接数</span></span><br><span class="line">    connectionQuotas.inc(socketChannel.socket().getInetAddress)</span><br><span class="line">    socketChannel.configureBlocking(<span class="literal">false</span>)</span><br><span class="line">    socketChannel.socket().setTcpNoDelay(<span class="literal">true</span>)</span><br><span class="line">    socketChannel.socket().setKeepAlive(<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">if</span> (sendBufferSize != <span class="type">Selectable</span>.<span class="type">USE_DEFAULT_BUFFER_SIZE</span>)</span><br><span class="line">      socketChannel.socket().setSendBufferSize(sendBufferSize)</span><br><span class="line">    debug(<span class="string">"Accepted connection from %s on %s and assigned it to processor %d, sendBufferSize [actual|requested]: [%d|%d] recvBufferSize [actual|requested]: [%d|%d]"</span></span><br><span class="line">          .format(socketChannel.socket.getRemoteSocketAddress, socketChannel.socket.getLocalSocketAddress, processor.id,</span><br><span class="line">                socketChannel.socket.getSendBufferSize, sendBufferSize,</span><br><span class="line">                socketChannel.socket.getReceiveBufferSize, recvBufferSize))</span><br><span class="line">      <span class="comment">//Processor处理I/O事件</span></span><br><span class="line">      processor.accept(socketChannel)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> e: <span class="type">TooManyConnectionsException</span> =&gt;</span><br><span class="line">      info(<span class="string">"Rejected connection from %s, address already has the configured maximum of %d connections."</span>.format(e.ip, e.count))</span><br><span class="line">      close(socketChannel)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Processor的accept将socketChannel存放在<code>ConcurrentLinkedQueue</code>中。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Queue up a new connection for reading</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">accept</span></span>(socketChannel: <span class="type">SocketChannel</span>) &#123;</span><br><span class="line">  newConnections.add(socketChannel)</span><br><span class="line">  wakeup()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后由Processor线程从队列中获取连接并交给<code>RequestChannel</code>处理。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123;</span><br><span class="line">  startupComplete()<span class="comment">//CountDownLatch</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//从队列中取出连接</span></span><br><span class="line">          configureNewConnections()</span><br><span class="line">          <span class="comment">//处理responseQueue</span></span><br><span class="line">          processNewResponses()</span><br><span class="line">          <span class="comment">//selector.poll</span></span><br><span class="line">          poll()</span><br><span class="line">          <span class="comment">//处理requestQueue</span></span><br><span class="line">          processCompletedReceives()</span><br><span class="line">          <span class="comment">//移除inflightResponses</span></span><br><span class="line">          processCompletedSends()</span><br><span class="line">          <span class="comment">//移除连接</span></span><br><span class="line">          processDisconnected()</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="comment">// We catch all the throwables here to prevent the processor thread from exiting. We do this because</span></span><br><span class="line">        <span class="comment">// letting a processor exit might cause a bigger impact on the broker. This behavior might need to be</span></span><br><span class="line">        <span class="comment">// reviewed if we see an exception that needs the entire broker to stop. Usually the exceptions thrown would</span></span><br><span class="line">        <span class="comment">// be either associated with a specific socket channel or a bad request. These exceptions are caught and</span></span><br><span class="line">        <span class="comment">// processed by the individual methods above which close the failing channel and continue processing other</span></span><br><span class="line">        <span class="comment">// channels. So this catch block should only ever see ControlThrowables.</span></span><br><span class="line">        <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt; processException(<span class="string">"Processor got uncaught exception."</span>, e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    debug(<span class="string">"Closing selector - processor "</span> + id)</span><br><span class="line">    <span class="type">CoreUtils</span>.swallow(closeAll(), <span class="keyword">this</span>, <span class="type">Level</span>.<span class="type">ERROR</span>)</span><br><span class="line">    shutdownComplete()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后，由<code>KafkaRequestHandlerPool</code>实现的简单线程池启动的<code>KafkaRequestHandler</code>线程，不断从<code>RequestChannel</code>中的<code>requestQueue</code>获取请求，然后调用<code>KafkaApis</code>处理业务逻辑，再返回给<code>RequestChannel</code>的<code>responseQueue</code>。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KafkaRequestHandlerPool</span>(<span class="params">val brokerId: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                              val requestChannel: <span class="type">RequestChannel</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                              val apis: <span class="type">KafkaApis</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                              time: <span class="type">Time</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                              numThreads: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Logging</span> <span class="keyword">with</span> <span class="title">KafkaMetricsGroup</span> </span>&#123;</span><br><span class="line">  <span class="comment">//线程池大小	</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> threadPoolSize: <span class="type">AtomicInteger</span> = <span class="keyword">new</span> <span class="type">AtomicInteger</span>(numThreads)</span><br><span class="line">  <span class="comment">/* a meter to track the average free capacity of the request handlers */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> aggregateIdleMeter = newMeter(<span class="string">"RequestHandlerAvgIdlePercent"</span>, <span class="string">"percent"</span>, <span class="type">TimeUnit</span>.<span class="type">NANOSECONDS</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.logIdent = <span class="string">"[Kafka Request Handler on Broker "</span> + brokerId + <span class="string">"], "</span></span><br><span class="line">  <span class="keyword">val</span> runnables = <span class="keyword">new</span> mutable.<span class="type">ArrayBuffer</span>[<span class="type">KafkaRequestHandler</span>](numThreads)</span><br><span class="line">  <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until numThreads) &#123;</span><br><span class="line">    createHandler(i)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//启动KafkaRequestHandler线程</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createHandler</span></span>(id: <span class="type">Int</span>): <span class="type">Unit</span> = synchronized &#123;</span><br><span class="line">    runnables += <span class="keyword">new</span> <span class="type">KafkaRequestHandler</span>(id, brokerId, aggregateIdleMeter, threadPoolSize, requestChannel, apis, time)</span><br><span class="line">    <span class="type">KafkaThread</span>.daemon(<span class="string">"kafka-request-handler-"</span> + id, runnables(id)).start()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">resizeThreadPool</span></span>(newSize: <span class="type">Int</span>): <span class="type">Unit</span> = synchronized &#123;</span><br><span class="line">    <span class="keyword">val</span> currentSize = threadPoolSize.get</span><br><span class="line">    info(<span class="string">s"Resizing request handler thread pool size from <span class="subst">$currentSize</span> to <span class="subst">$newSize</span>"</span>)</span><br><span class="line">    <span class="keyword">if</span> (newSize &gt; currentSize) &#123;</span><br><span class="line">      <span class="keyword">for</span> (i &lt;- currentSize until newSize) &#123;</span><br><span class="line">        createHandler(i)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newSize &lt; currentSize) &#123;</span><br><span class="line">      <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to (currentSize - newSize)) &#123;</span><br><span class="line">        runnables.remove(currentSize - i).stop()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    threadPoolSize.set(newSize)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">shutdown</span></span>(): <span class="type">Unit</span> = synchronized &#123;</span><br><span class="line">    info(<span class="string">"shutting down"</span>)</span><br><span class="line">    <span class="keyword">for</span> (handler &lt;- runnables)</span><br><span class="line">      handler.initiateShutdown()</span><br><span class="line">    <span class="keyword">for</span> (handler &lt;- runnables)</span><br><span class="line">      handler.awaitShutdown()</span><br><span class="line">    info(<span class="string">"shut down completely"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A thread that answers kafka requests.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KafkaRequestHandler</span>(<span class="params">id: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                          brokerId: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                          val aggregateIdleMeter: <span class="type">Meter</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                          val totalHandlerThreads: <span class="type">AtomicInteger</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                          val requestChannel: <span class="type">RequestChannel</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                          apis: <span class="type">KafkaApis</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                          time: <span class="type">Time</span></span>) <span class="keyword">extends</span> <span class="title">Runnable</span> <span class="keyword">with</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.logIdent = <span class="string">"[Kafka Request Handler "</span> + id + <span class="string">" on Broker "</span> + brokerId + <span class="string">"], "</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> shutdownComplete = <span class="keyword">new</span> <span class="type">CountDownLatch</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="meta">@volatile</span> <span class="keyword">private</span> <span class="keyword">var</span> stopped = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123;</span><br><span class="line">    <span class="keyword">while</span> (!stopped) &#123;</span><br><span class="line">      <span class="comment">// We use a single meter for aggregate idle percentage for the thread pool.</span></span><br><span class="line">      <span class="comment">// Since meter is calculated as total_recorded_value / time_window and</span></span><br><span class="line">      <span class="comment">// time_window is independent of the number of threads, each recorded idle</span></span><br><span class="line">      <span class="comment">// time should be discounted by # threads.</span></span><br><span class="line">      <span class="keyword">val</span> startSelectTime = time.nanoseconds</span><br><span class="line">      <span class="comment">//获取请求</span></span><br><span class="line">      <span class="keyword">val</span> req = requestChannel.receiveRequest(<span class="number">300</span>)</span><br><span class="line">      <span class="keyword">val</span> endTime = time.nanoseconds</span><br><span class="line">      <span class="keyword">val</span> idleTime = endTime - startSelectTime</span><br><span class="line">      aggregateIdleMeter.mark(idleTime / totalHandlerThreads.get)</span><br><span class="line">      </span><br><span class="line">      req <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">RequestChannel</span>.<span class="type">ShutdownRequest</span> =&gt;</span><br><span class="line">          debug(<span class="string">s"Kafka request handler <span class="subst">$id</span> on broker <span class="subst">$brokerId</span> received shut down command"</span>)</span><br><span class="line">          shutdownComplete.countDown()</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> request: <span class="type">RequestChannel</span>.<span class="type">Request</span> =&gt;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            request.requestDequeueTimeNanos = endTime</span><br><span class="line">            trace(<span class="string">s"Kafka request handler <span class="subst">$id</span> on broker <span class="subst">$brokerId</span> handling request <span class="subst">$request</span>"</span>)</span><br><span class="line">            <span class="comment">//由KafkaApis来处理业务逻辑</span></span><br><span class="line">            apis.handle(request)</span><br><span class="line">          &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> e: <span class="type">FatalExitError</span> =&gt;</span><br><span class="line">              shutdownComplete.countDown()</span><br><span class="line">              <span class="type">Exit</span>.exit(e.statusCode)</span><br><span class="line">            <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt; error(<span class="string">"Exception when handling request"</span>, e)</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            request.releaseBuffer()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="literal">null</span> =&gt; <span class="comment">// continue</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    shutdownComplete.countDown()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">stop</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    stopped = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initiateShutdown</span></span>(): <span class="type">Unit</span> = requestChannel.sendShutdownRequest()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">awaitShutdown</span></span>(): <span class="type">Unit</span> = shutdownComplete.await()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>KafkaApis</code>的<code>handle</code>方法逻辑。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Top-level method that handles all requests and multiplexes to the right api</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">handle</span></span>(request: <span class="type">RequestChannel</span>.<span class="type">Request</span>) &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     trace(<span class="string">s"Handling request:<span class="subst">$&#123;request.requestDesc(true)&#125;</span> from connection <span class="subst">$&#123;request.context.connectionId&#125;</span>;"</span> +</span><br><span class="line">       <span class="string">s"securityProtocol:<span class="subst">$&#123;request.context.securityProtocol&#125;</span>,principal:<span class="subst">$&#123;request.context.principal&#125;</span>"</span>)</span><br><span class="line">     request.header.apiKey <span class="keyword">match</span> &#123;</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">PRODUCE</span> =&gt; handleProduceRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">FETCH</span> =&gt; handleFetchRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">LIST_OFFSETS</span> =&gt; handleListOffsetRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">METADATA</span> =&gt; handleTopicMetadataRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">LEADER_AND_ISR</span> =&gt; handleLeaderAndIsrRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">STOP_REPLICA</span> =&gt; handleStopReplicaRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">UPDATE_METADATA</span> =&gt; handleUpdateMetadataRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">CONTROLLED_SHUTDOWN</span> =&gt; handleControlledShutdownRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">OFFSET_COMMIT</span> =&gt; handleOffsetCommitRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">OFFSET_FETCH</span> =&gt; handleOffsetFetchRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">FIND_COORDINATOR</span> =&gt; handleFindCoordinatorRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">JOIN_GROUP</span> =&gt; handleJoinGroupRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">HEARTBEAT</span> =&gt; handleHeartbeatRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">LEAVE_GROUP</span> =&gt; handleLeaveGroupRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">SYNC_GROUP</span> =&gt; handleSyncGroupRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">DESCRIBE_GROUPS</span> =&gt; handleDescribeGroupRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">LIST_GROUPS</span> =&gt; handleListGroupsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">SASL_HANDSHAKE</span> =&gt; handleSaslHandshakeRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">API_VERSIONS</span> =&gt; handleApiVersionsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">CREATE_TOPICS</span> =&gt; handleCreateTopicsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">DELETE_TOPICS</span> =&gt; handleDeleteTopicsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">DELETE_RECORDS</span> =&gt; handleDeleteRecordsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">INIT_PRODUCER_ID</span> =&gt; handleInitProducerIdRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">OFFSET_FOR_LEADER_EPOCH</span> =&gt; handleOffsetForLeaderEpochRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">ADD_PARTITIONS_TO_TXN</span> =&gt; handleAddPartitionToTxnRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">ADD_OFFSETS_TO_TXN</span> =&gt; handleAddOffsetsToTxnRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">END_TXN</span> =&gt; handleEndTxnRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">WRITE_TXN_MARKERS</span> =&gt; handleWriteTxnMarkersRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">TXN_OFFSET_COMMIT</span> =&gt; handleTxnOffsetCommitRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">DESCRIBE_ACLS</span> =&gt; handleDescribeAcls(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">CREATE_ACLS</span> =&gt; handleCreateAcls(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">DELETE_ACLS</span> =&gt; handleDeleteAcls(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">ALTER_CONFIGS</span> =&gt; handleAlterConfigsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">DESCRIBE_CONFIGS</span> =&gt; handleDescribeConfigsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">ALTER_REPLICA_LOG_DIRS</span> =&gt; handleAlterReplicaLogDirsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">DESCRIBE_LOG_DIRS</span> =&gt; handleDescribeLogDirsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">SASL_AUTHENTICATE</span> =&gt; handleSaslAuthenticateRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">CREATE_PARTITIONS</span> =&gt; handleCreatePartitionsRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">CREATE_DELEGATION_TOKEN</span> =&gt; handleCreateTokenRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">RENEW_DELEGATION_TOKEN</span> =&gt; handleRenewTokenRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">EXPIRE_DELEGATION_TOKEN</span> =&gt; handleExpireTokenRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">DESCRIBE_DELEGATION_TOKEN</span> =&gt; handleDescribeTokensRequest(request)</span><br><span class="line">       <span class="keyword">case</span> <span class="type">ApiKeys</span>.<span class="type">DELETE_GROUPS</span> =&gt; handleDeleteGroupsRequest(request)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">     <span class="keyword">case</span> e: <span class="type">FatalExitError</span> =&gt; <span class="keyword">throw</span> e</span><br><span class="line">     <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt; handleError(request, e)</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">     request.apiLocalCompleteTimeNanos = time.nanoseconds</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>每个业务处理完结果都存入<code>RequestChannel</code>中。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">sendResponse</span></span>(request: <span class="type">RequestChannel</span>.<span class="type">Request</span>, responseOpt: <span class="type">Option</span>[<span class="type">AbstractResponse</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// Update error metrics for each error code in the response including Errors.NONE</span></span><br><span class="line">  responseOpt.foreach(response =&gt; requestChannel.updateErrorMetrics(request.header.apiKey, response.errorCounts.asScala))</span><br><span class="line"></span><br><span class="line">  responseOpt <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Some</span>(response) =&gt;</span><br><span class="line">      <span class="keyword">val</span> responseSend = request.context.buildResponse(response)</span><br><span class="line">      <span class="keyword">val</span> responseString =</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">RequestChannel</span>.isRequestLoggingEnabled) <span class="type">Some</span>(response.toString(request.context.apiVersion))</span><br><span class="line">        <span class="keyword">else</span> <span class="type">None</span></span><br><span class="line">      requestChannel.sendResponse(<span class="keyword">new</span> <span class="type">RequestChannel</span>.<span class="type">Response</span>(request, <span class="type">Some</span>(responseSend), <span class="type">SendAction</span>, responseString))</span><br><span class="line">    <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">      requestChannel.sendResponse(<span class="keyword">new</span> <span class="type">RequestChannel</span>.<span class="type">Response</span>(request, <span class="type">None</span>, <span class="type">NoOpAction</span>, <span class="type">None</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Send a response back to the socket server to be sent over the network */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendResponse</span></span>(response: <span class="type">RequestChannel</span>.<span class="type">Response</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isTraceEnabled) &#123;</span><br><span class="line">    <span class="keyword">val</span> requestHeader = response.request.header</span><br><span class="line">    <span class="keyword">val</span> message = response.responseAction <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">SendAction</span> =&gt;</span><br><span class="line">        <span class="string">s"Sending <span class="subst">$&#123;requestHeader.apiKey&#125;</span> response to client <span class="subst">$&#123;requestHeader.clientId&#125;</span> of <span class="subst">$&#123;response.responseSend.get.size&#125;</span> bytes."</span></span><br><span class="line">      <span class="keyword">case</span> <span class="type">NoOpAction</span> =&gt;</span><br><span class="line">        <span class="string">s"Not sending <span class="subst">$&#123;requestHeader.apiKey&#125;</span> response to client <span class="subst">$&#123;requestHeader.clientId&#125;</span> as it's not required."</span></span><br><span class="line">      <span class="keyword">case</span> <span class="type">CloseConnectionAction</span> =&gt;</span><br><span class="line">        <span class="string">s"Closing connection for client <span class="subst">$&#123;requestHeader.clientId&#125;</span> due to error during <span class="subst">$&#123;requestHeader.apiKey&#125;</span>."</span></span><br><span class="line">    &#125;</span><br><span class="line">    trace(message)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> processor = processors.get(response.processor)</span><br><span class="line">  <span class="comment">// The processor may be null if it was shutdown. In this case, the connections</span></span><br><span class="line">  <span class="comment">// are closed, so the response is dropped.</span></span><br><span class="line">  <span class="keyword">if</span> (processor != <span class="literal">null</span>) &#123;</span><br><span class="line">    processor.enqueueResponse(response)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[network] <span class="function"><span class="keyword">def</span> <span class="title">enqueueResponse</span></span>(response: <span class="type">RequestChannel</span>.<span class="type">Response</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  responseQueue.put(response)</span><br><span class="line">  wakeup()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>生命就是个Bug.</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://bug-free.cn/2020/01/18/Kafka-网络通信模型/" title="Kafka - 网络通信模型">https://bug-free.cn/2020/01/18/Kafka-网络通信模型/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Kafka/" rel="tag"># Kafka</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2020/01/16/Kafka-消息到达保证机制/" rel="next" title="Kafka - 消息到达保证机制"><i class="fa fa-chevron-left"></i> Kafka - 消息到达保证机制</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2020/01/19/Kafka-高可用设计/" rel="prev" title="Kafka - 高可用设计">Kafka - 高可用设计 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"><div id="utterance-container"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="生命就是个Bug."><p class="site-author-name" itemprop="name">生命就是个Bug.</p><div class="site-description" itemprop="description">说出你的故事</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/suzunshou" title="GitHub &rarr; https://github.com/suzunshou" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:suzunshou@qq.com" title="E-Mail &rarr; mailto:suzunshou@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://weibo.com/suzunshou" title="Weibo &rarr; https://weibo.com/suzunshou" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a> </span><span class="links-of-author-item"><a href="https://twitter.com/suzunshou" title="Twitter &rarr; https://twitter.com/suzunshou" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"><a href="http://www.beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备20007595号 </a><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=" rel="noopener" target="_blank"></a>&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">生命就是个Bug.</span></div><div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div><span class="post-meta-divider">|</span><div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.0</div></div></footer></div><script src="/lib/anime.min.js?v=3.1.0"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script><script src="/js/schemes/pisces.js?v=7.4.0"></script><script src="/js/next-boot.js?v=7.4.0"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js?v=7.4.0"></script><script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.setAttribute("issue-term","title"),t.setAttribute("theme","github-light"),t.setAttribute("repo","suzunshou/suzunshou.github.io"),t.crossorigin="anonymous",t.src="https://utteranc.es/client.js",document.getElementById("utterance-container").appendChild(t)}()</script></body></html>